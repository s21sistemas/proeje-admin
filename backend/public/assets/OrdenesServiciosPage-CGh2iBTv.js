import{j as e,u as Q,t as f}from"./index-CB-Ik059.js";import{I as _,C as K,B as T,a as L}from"./CancelButtonModal-DFIIInB4.js";import{d as R,k as q,u as w,B as Y}from"./BaseTable-lMESkOGa.js";import{M as J}from"./ModalDelete-Bkq3cXQz.js";import{A as h}from"./AlertaCard-azZSUJ8e.js";import{a as S,u as P}from"./configAxios-zIrC1_jU.js";import{u as F,S as v}from"./sweetalert2.esm.all-nsIXK1sI.js";import"./square-pen-D170uhu7.js";const G={generalFields:[{required:!0,type:"async",label:"Selecciona la empresa (cotización aceptada) *",name:"venta_id"},{required:!0,type:"textarea",label:"Domicilio del servicio *",name:"domicilio_servicio"},{required:!0,type:"datetime-local",label:"Fecha de inicio del servicio *",name:"fecha_inicio"},{required:!0,type:"datetime-local",label:"Fecha del fin del servicio *",name:"fecha_fin"},{required:!0,type:"text",label:"Nombre de la persona responsable en sitio *",name:"nombre_responsable_sitio"},{required:!0,type:"number",label:"Teléfono de la persona responsable en sitio *",name:"telefono_responsable_sitio"},{required:!1,type:"textarea",label:"Observaciones",name:"observaciones"}],rfcFields:[{required:!1,type:"text",label:"RFC *",name:"rfc"},{required:!1,type:"text",label:"Razón social *",name:"razon_social"},{required:!1,type:"text",label:"Uso de CFDI *",name:"uso_cfdi"},{required:!1,type:"text",label:"Regimen fiscal *",name:"regimen_fiscal"}]},U=()=>{const{view:r,edit:a,formData:i,handleInputChange:t,loadOptionsVentas:s,loadOptionsGuardias:p,loadOptionsSupervisores:b,loadOptionsJefesGrupo:m,handleCheckboxChange:d}=R();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6 md:grid-cols-2 mb-7",children:[a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Estado de la orden de servicio"})}),e.jsx(_,{type:"select",label:"Selecciona el estado de la orden de servicio *",name:"estatus",required:!0,value:i.estatus||"",opcSelect:[{label:"Selecciona una opción",value:""},{label:"En proceso",value:"En proceso"},{label:"Finalizada",value:"Finalizada"},{label:"Cancelada",value:"Cancelada"}],onChange:t,disabled:r,classInput:"md:col-span-2"})]}),e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Información de la orden de servicio"})}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",name:"cambiar_direccion",onChange:d,className:"sr-only peer outline-0",disabled:r}),e.jsx("div",{className:"relative w-9 h-5 bg-gray-500 cursor-pointer peer-disabled:bg-gray-300 peer-disabled:cursor-auto peer-focus:outline-0 outline-0 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"}),e.jsx("span",{className:"ms-3 text-sm font-medium text-gray-900",children:"¿Quiéres cambiar la dirección del servicio?"})]}),G.generalFields.map(({type:u,label:l,name:c,required:g})=>e.jsx(_,{type:u,label:l,name:c,required:g,value:i[c]||"",loadOptions:s,onChange:t,disabled:c==="domicilio_servicio"?!i.cambiar_direccion:r,classInput:"md:col-span-2"},c)),e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Asignación de guardias"})}),e.jsx(_,{type:"async-multi",label:"Guardias a asignar *",name:"guardias_id",required:!0,value:i.guardias_id||"",loadOptions:p,onChange:t,disabled:r,classInput:"md:col-span-2"}),i.supervisor==="SI"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Asignación de supervisores"})}),e.jsx(_,{type:"async",label:"Supervisor a asignar *",name:"supervisor_id",required:!0,value:i.supervisor_id||"",loadOptions:b,onChange:t,disabled:r,classInput:"md:col-span-2"})]}),i.jefe_grupo==="SI"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Asignación de jefe de grupos"})}),e.jsx(_,{type:"async",label:"Jefe de grupo a asignar *",name:"jefe_grupo_id",required:!0,value:i.jefe_grupo_id||"",loadOptions:m,onChange:t,disabled:r,classInput:"md:col-span-2"})]}),(r||a)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sm:col-span-6 md:col-span-2",children:e.jsx(h,{text:"Datos fiscales informativos de la sucursal"})}),G.rfcFields.map(({type:u,label:l,name:c,required:g})=>e.jsx(_,{type:u,label:l,name:c,required:g,value:i[c]||"",onChange:t,disabled:!0,classInput:"md:col-span-1",document:i[`${c}_url`]||null},c))]})]}),e.jsx("hr",{className:"text-gray-300"}),r?e.jsx(K,{}):e.jsx(T,{})]})},V=async r=>{try{return(await S.post("orden-servicio",r)).data}catch(a){throw console.error("Error al crear el registro",a),new Error(a.response.data.message)}},H=async()=>{var r,a;try{const i=await S.get("orden-servicio"),{data:t}=i;return t.map(s=>{var x,y,j,C,E,O,z,N,$,D,I,M,k,A,B;const p=s.ordenes_servicio_guardias.map(n=>`${n.guardia.nombre} ${n.guardia.apellido_p} (${n.guardia.rango})`).toString().replaceAll(",",", "),m=s.ordenes_servicio_guardias.filter(n=>n.guardia.rango==="Guardia").map(n=>n.guardia).map(n=>({label:`${n.nombre} ${n.apellido_p} ${n.apellido_m}`,value:n.id})),d=s.ordenes_servicio_guardias.find(n=>n.guardia.rango==="Supervisor"),u=d?{label:`${d.guardia.nombre} ${d.guardia.apellido_p} ${d.guardia.apellido_m}`,value:d.guardia.id}:null,l=s.ordenes_servicio_guardias.find(n=>n.guardia.rango==="Jefe de grupo"),c=l?{label:`${l.guardia.nombre} ${l.guardia.apellido_p} ${l.guardia.apellido_m}`,value:l.guardia.id}:null,g=(y=(x=s.venta)==null?void 0:x.cotizacion)!=null&&y.sucursal?(E=(C=(j=s.venta)==null?void 0:j.cotizacion)==null?void 0:C.sucursal)==null?void 0:E.nombre_empresa:(z=(O=s.venta)==null?void 0:O.cotizacion)==null?void 0:z.nombre_empresa,o={label:`${g} (${s.venta.numero_factura})`,value:s.venta.id};return{...s,venta_id:o,guardias_id:m,supervisor_id:u,jefe_grupo_id:c,supervisor:s.venta.cotizacion.supervisor,jefe_grupo:s.venta.cotizacion.jefe_grupo,nombre_empresa:g,asignados:p,inicio_format:q(s.fecha_inicio).format("DD/MM/YYYY"),rfc:(($=(N=s.venta.cotizacion)==null?void 0:N.sucursal)==null?void 0:$.rfc)||"N/A",razon_social:((I=(D=s.venta.cotizacion)==null?void 0:D.sucursal)==null?void 0:I.razon_social)||"N/A",uso_cfdi:((k=(M=s.venta.cotizacion)==null?void 0:M.sucursal)==null?void 0:k.uso_cfdi)||"N/A",regimen_fiscal:((B=(A=s.venta.cotizacion)==null?void 0:A.sucursal)==null?void 0:B.regimen_fiscal)||"N/A"}})}catch(i){throw console.error("Error al obetener el registro",i),new Error(((a=(r=i.response)==null?void 0:r.data)==null?void 0:a.message)||"Error al obtener los datos")}},W=async r=>{try{const{id:a}=r;return(await S.put(`orden-servicio/${a}`,r)).data}catch(a){throw console.error("Error al actualizar registro:",a),new Error(a.response.data.message)}},X=async r=>{try{return(await S.delete(`orden-servicio/${r}`)).data}catch(a){throw console.error("Error al eliminar registro:",a),new Error(a.response.data.message)}},Z=()=>{const r=w(o=>o.modalType),a=w(o=>o.formData),i=w(o=>o.closeModal),t=Q(),{isError:s,data:p,error:b,isLoading:m}=P({queryKey:["ordenes-servicios"],queryFn:H}),d=F({mutationFn:V,onSuccess:()=>{t.invalidateQueries({queryKey:["ordenes-servicios"]}),f.success("Registro agregado"),i(),v.close()},onError:o=>{f.error(o.message),v.close()}}),u=F({mutationFn:W,onSuccess:()=>{t.invalidateQueries({queryKey:["ordenes-servicios"]}),f.success("Registro actualizado"),i(),v.close()},onError:o=>{f.error(o.message),v.close()}}),l=F({mutationFn:X,onSuccess:()=>{t.invalidateQueries({queryKey:["ordenes-servicios"]}),f.success("Registro eliminado")},onError:o=>{f.error(o.message)}});return{isLoading:m,isError:s,data:p,error:b,createMutation:d,updateMutation:u,deleteMutation:l,handleSubmit:o=>{var y,j;if(o.preventDefault(),v.fire({title:'<h2 style="font-family: "sans-serif";">Guardando registro, por favor espere...</h2>',allowEscapeKey:!1,allowOutsideClick:!1,timerProgressBar:!0,didOpen:()=>{v.showLoading()}}),q(a.fecha_inicio).isAfter(q(a.fecha_fin))){f.warning("La fecha de fin no puede ser antes que la fecha de inicio"),v.close();return}const x={...a,venta_id:a.venta_id.value,jefe_grupo_id:((y=a.jefe_grupo_id)==null?void 0:y.value)||null,supervisor_id:((j=a.supervisor_id)==null?void 0:j.value)||null};r==="add"?d.mutate(x):r==="edit"&&u.mutate(x)},handleDelete:o=>{l.mutate(o),i()}}},ee=[{key:"nombre_empresa",name:"Sucursal"},{key:"domicilio_servicio",name:"Domicilio"},{key:"inicio_format",name:"Fecha inicio"},{key:"asignados",name:"Guardias"},{key:"estatus",name:"Estatus"}];function ce(){const{modalType:r,currentItem:a}=R(),{data:i,isLoading:t,isError:s,error:p,handleSubmit:b,handleDelete:m}=Z();return s?e.jsx("div",{children:p.message}):e.jsxs("div",{className:"md:p-4 bg-gray-100",children:[e.jsx(Y,{columns:ee,data:i||[],title:"Ordenes de servicio",loading:t}),(r==="add"||r==="edit"||r==="view")&&e.jsx(L,{handleSubmit:b,Inputs:e.jsx(U,{})}),r==="delete"&&a&&e.jsx(J,{handleDelete:m})]})}export{ce as default};
